version: 2

# What is this - http://yaml.org/type/merge.html
defaults: &defaults
  docker:
    - image: circleci/node:9.3

jobs:
    build:
        <<: *defaults
        steps:
            - checkout
            - restore_cache:
                key: node-modules-{{ checksum "package.json" }}
            - run:
                name: Install modules
                command: yarn --frozen-lockfile install
            - save_cache:
                key: node-modules-{{ checksum "package.json" }}
                paths:
                    - node_modules
            - run:
                name: Building
                command: yarn build
            - persist_to_workspace:
                root: ./
                paths:
                    - ./
    lint:
        <<: *defaults
        steps:
            - attach_workspace:
                at: ./
            - run:
                name: Ensuring prettified
                command: yarn prettier:ci
            - run:
                name: Linting
                command: yarn lint
    test:
        <<: *defaults
        steps:
            - attach_workspace:
                at: ./
            - run:
                name: Starting Ganache
                command: yarn ganache
                background: true
            - run:
                name: Running tests
                command: yarn test

    setup-gcp:
        <<: *defaults
        docker:
            - image: civilmedia/gcloud-node:latest
        steps:
            - run:
                name: Dump Google Cloud Credentials to file
                command: |
                    echo ${GOOGLE_AUTH} | base64 -d > ./gcp-key.json
                    gcloud auth activate-service-account --key-file ./gcp-key.json
                    gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
                    gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
                    gcloud --quiet container clusters get-credentials ${GOOGLE_CLUSTER_NAME}
                    gcloud docker --authorize-only
            - persist_to_workspace:
                root: ./
                paths:
                    - gcp-key.json
                    - .config/gcloud
                    - .docker
                    - .dockercfg
                    - .kubernetes_ns
                    - .kube

    push-containers:
        <<: *defaults
        docker:
            - image: civilmedia/gcloud-node:latest
        steps:
            - attach_workspace:
                at: ./
            - setup_remote_docker
            - run:
                name: Build Container
                command: |
                    TAG=`echo $CIRCLE_BRANCH | sed 's/\\//_/g'`
                    docker build -f Dockerfile-dapp . \
                    -t gcr.io/$GOOGLE_PROJECT_ID/dapp:$TAG \
                    -t gcr.io/$GOOGLE_PROJECT_ID/dapp:$TAG-$CIRCLE_SHA1
            - deploy:
                name: Push Containers to Registry
                command: |
                    gcloud config list
                    echo "pushing $GOOGLE_PROJECT_ID"
                    docker push gcr.io/$GOOGLE_PROJECT_ID/dapp

    deploy-staging:
        <<: *defaults
        docker:
            - image: civilmedia/gcloud-node:latest
        steps:
            - attach_workspace:
                at: ./
            - deploy:
                name: Update Kubernetes Deployment on STAGING
                command: |
                    kubectl set image deployment/dapp dapp=gcr.io/$GOOGLE_PROJECT_ID/dapp:master-$CIRCLE_SHA1 --namespace staging

workflows:
    version: 2
    everything:
        jobs:
            - build
            - test:
                requires:
                    - build
            - lint:
                requires:
                    - build
            - setup-gcp:
                context: gcp-common
                requires:
                    - test
                    - lint
                filters:
                    branches:
                        only:
                            - master
            - push-containers:
                context: gcp-common
                requires:
                    - setup-gcp
                filters:
                    branches:
                        only:
                            - master
            - deploy-staging:
                context: gcp-common
                requires:
                    - push-containers
                filters:
                    branches:
                        only:
                            - master
